<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta type="mtml">
    <!-- <link rel="icon" href="./favicon.ico"/> -->
    <title>&lrm;</title>
    <!-- 空字符 \u200E &lrm; -->
    <link rel="stylesheet" href="/general.css">
    <style>
        html {
            height: 100%;
            line-height: normal;
            margin: 0;
        }
        body {
            height: 90%;
        }
        .inputs {
            display: block;
            height: 18%;
            width: 80%;
            margin: 2% 5%;
            font-size: larger;
            border-radius: 20px;
            padding: 10px;
        }
        .output {
            display: block;
            width: 80%;
            margin: 2% 5%;
            font-size: larger;
            border-radius: 20px;
            padding: 10px;
        }
        .buttons {
            margin: 8px;
            background-color: white;
            border-radius: 10px;
            border-width: 8px;
            font-size: large;
            padding: 2px;
        }
        .buttons:hover {
            color: gray;
        }
        #menu {
            display: none;
            position: fixed;
            height: 40%;
            width: 80%;
        }
        #general {
            height: 100%;
            font-size: larger;
        }
        #none {
            display: none;
        }
        #percent {
            text-align: center;
            position: absolute;
            top: -10%;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            font-size: 25px;
            font-weight: bolder;
            width: fit-content;
            height: fit-content;
        }
        /* https://loading.io/css/抄来的加载动画，CC0协议随便用（不是） */
        .lds-ellipsis {
            display: inline-block;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            width: 80px;
            height: 80px;
        }
        .lds-ellipsis div {
            position: absolute;
            top: 33px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: #000;
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        .lds-ellipsis div:nth-child(1) {
            left: 8px;
            animation: lds-ellipsis1 0.6s infinite;
        }
        .lds-ellipsis div:nth-child(2) {
            left: 8px;
            animation: lds-ellipsis2 0.6s infinite;
        }
        .lds-ellipsis div:nth-child(3) {
            left: 32px;
            animation: lds-ellipsis2 0.6s infinite;
        }
        .lds-ellipsis div:nth-child(4) {
            left: 56px;
            animation: lds-ellipsis3 0.6s infinite;
        }
        @keyframes lds-ellipsis1 {
            0% {
                transform: scale(0);
            }
            100% {
                transform: scale(1);
            }
        }
        @keyframes lds-ellipsis3 {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(0);
            }
        }
        @keyframes lds-ellipsis2 {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(24px, 0);
            }
        }
    </style>
</head>
<body>
    <div id="percent">0%</div>
    <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
    <div id="none">
        <input id="input" class="inputs" placeholder="填入URL或文本" type="text">
        <input id="key" class="inputs" placeholder="填入密钥" type="text">
        <input id="iv" class="inputs" placeholder="填入向量" type="text">
        <button class="buttons" onclick="GetMtml(
            document.querySelector('#input').value,

            document.querySelector('#key').value,

            document.querySelector('#iv').value,

            !document.querySelector('#input').value.endsWith('.mdf'),
            
            document.querySelector('#input').value.endsWith('.mdf'))
        .then(res => {
            if (typeof res === 'string') {
                if (!res.includes('</html>'))
                    alert('解析失败！请检查源文件是否为合法的MTML、密钥及向量！')

                else {
                    document.write(res)

                    document.close()
                }
            }
            if (typeof res === 'object') {
                const download = document.createElement('a')
                        
                const url = window.URL.createObjectURL(new Blob([res], {
                            type: 'application/pdf;charset=UTF-8'
                        }))

                window.location = url

                window.URL.revokeObjectURL(url)
            }
        })">读取</button>
        <button class="buttons" onclick="Encrypt(
            document.querySelector('#input').value,

            document.querySelector('#key').value,
            
            document.querySelector('#iv').value)
        .then(res => {
            if (typeof res === 'string')
                document.querySelector('.output').value = res
        })">加密文本</button>
        <button class="buttons" onclick="EncryptFile()">加密HTML</button>
        <button class="buttons" onclick="EncryptFile(true)">加密PDF</button>
        <button class="buttons" onclick="
            if (key.length !== 32) {
                alert(`密钥的字节数必须为32！当前为${typeof key != 'undefined' ? key.length : 0}`)

                return ''
            }

            if (iv.length !== 16) {
                alert(`向量的字节数必须为16！当前为${typeof iv != 'undefined' ? iv.length : 0}`)

                return ''
            }

            const input = document.createElement('input')

            input.type = 'file'

            input.accept = '.mdf'

            input.onchange = async e => {
                if (input.files.length !== 0) {
                    for (let i = 0, len = input.files.length; i < len; i++) {
                        key = aesjs.utils.utf8.toBytes(key)

                        iv = aesjs.utils.utf8.toBytes(iv)

                        const content = new Uint8Array(await input.files[i].arrayBuffer())

                        const file = new Blob([new aesjs.ModeOfOperation.ofb(key, iv).decrypt(content)], {
                            type: 'application/force-download;charset=UTF-8'
                        })

                        const download = document.createElement('a')

                        const url = window.URL.createObjectURL(file)

                        download.href = url

                        download.download = input.files[i].name.replace('.mdf', '.pdf')

                        download.click()

                        window.URL.revokeObjectURL(url)
                    }
                }
            }
        ">解密本地PDF</button>
        <button class="buttons" id="newKey">生成新密钥</button>
        <button class="buttons" id="newIv">生成新向量</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            key.default = document.querySelector('#key').value

            iv.default = document.querySelector('#iv').value

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('保存成功！')
        })()">将当前密钥与向量保存为默认值</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            if (typeof key.default === 'string')
                delete key.default

            if (typeof iv.default === 'string')
                delete iv.default

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('清除成功！')
        })()">清除默认密钥与向量</button>
        <button class="buttons" onclick="GetMtml(
            document.querySelector('#input').value,

            document.querySelector('#key').value,

            document.querySelector('#iv').value)
        .then(res => {
            if (typeof res === 'string')
            {
                if (!res.includes('</html>'))
                    alert('解析失败！请检查源文件是否为合法的MTML、密钥及向量！')

                else {
                    const text = new Blob([res], {
                        type: 'application/force-download;charset=UTF-8'
                    })

                    const download = document.createElement('a')
                        
                    const url = window.URL.createObjectURL(text)

                    download.href = url

                    download.download = document.querySelector('#input').value
                        .substr(document.querySelector('#input').value.lastIndexOf('/') + 1)
                        .replace('.mtml', '.html')

                    download.click()

                    window.URL.revokeObjectURL(url)
                }
            }
        })">下载读取文件</button>
        <!-- 从这里开始往下的每一个onclick事件都采用(function(){})()这种逆天写法的原因是为了限制变量声明作用域 -->
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            key.access1 = document.querySelector('#key').value

            iv.access1 = document.querySelector('#iv').value

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('保存成功！')
        })()">保存通行等级1</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            key.access2 = document.querySelector('#key').value

            iv.access2 = document.querySelector('#iv').value

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('保存成功！')
        })()">保存通行等级2</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            key.access3 = document.querySelector('#key').value

            iv.access3 = document.querySelector('#iv').value

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('保存成功！')
        })()">保存通行等级3</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            key.access4 = document.querySelector('#key').value

            iv.access4 = document.querySelector('#iv').value

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('保存成功！')
        })()">保存通行等级4</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            const level = prompt('请输入等级：')

            key[level] = document.querySelector('#key').value

            iv[level] = document.querySelector('#iv').value

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('保存成功！')
        })()">保存自定义等级</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            if (typeof key.access1 === 'string')
                delete key.access1

            if (typeof iv.access1 === 'string')
                delete iv.access1

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('清除成功！')
        })()">清除通行等级1</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            if (typeof key.access2 === 'string')
                delete key.access2

            if (typeof iv.access2 === 'string')
                delete iv.access2

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('清除成功！')
        })()">清除通行等级2</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            if (typeof key.access3 === 'string')
                delete key.access3

            if (typeof iv.access3 === 'string')
                delete iv.access3

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('清除成功！')
        })()">清除通行等级3</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            if (typeof key.access4 === 'string')
                delete key.access4

            if (typeof iv.access4 === 'string')
                delete iv.access4

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('清除成功！')
        })()">清除通行等级4</button>
        <button class="buttons" onclick="(function () {
            const key = JSON.parse(localStorage.getItem('key'))

            const iv = JSON.parse(localStorage.getItem('iv'))

            const level = prompt('请输入等级：')

            if (typeof key[level] === 'string')
                delete key[level]

            if (typeof iv[level] === 'string')
                delete iv[level]

            localStorage.setItem('key', JSON.stringify(key))
            
            localStorage.setItem('iv', JSON.stringify(iv))

            alert('清除成功！')
        })()">清除自定义通行等级</button>
        <button class="buttons" onclick="(function () {
            const keys = JSON.parse(localStorage.getItem('key'))

            const ivs = JSON.parse(localStorage.getItem('iv'))

            if (Object.keys(keys).toString() === Object.keys(keys).toString()) {
                for (let key in keys) {
                    prompt(undefined, `等级：${key} 密钥：${keys[key]} 向量：${ivs[key]}`)
                }
            }

            else {
                alert('密钥与向量无法匹配！将显示所有密钥与向量')

                for (let key in keys) {
                    prompt(undefined, `等级：${key} 密钥：${keys[key]}`)
                }

                for (let iv in ivs) {
                    prompt(undefined, `等级：${iv} 向量：${ivs[iv]}`)
                }
            }
        })()">显示当前已有的所有等级</button>
        <button class="buttons" onclick="(function () {
            const input = prompt('请输入通行等级：')

            if (typeof input === 'string' && input.length !== 0) {
                const params = input.split(' ')

                const obj = {}

                params.forEach(x => {
                    const dic = x.split('：')

                    if (dic.length === 2)
                        switch (dic[0]) {
                            case '等级':
                                obj.level = dic[1]

                                break
                                
                            case '密钥':
                                obj.key = dic[1]

                                break

                            case '向量':
                                obj.iv = dic[1]

                                break

                            default:
                                obj.error = true

                                alert('通行等级无效！')

                                break
                        }
                })

                if (typeof obj.error === 'undefined'
                && typeof obj.level !== 'undefined'
                && typeof obj.key !== 'undefined'
                && typeof obj.iv !== 'undefined') {
                    const key = JSON.parse(localStorage.getItem('key'))

                    const iv = JSON.parse(localStorage.getItem('iv'))

                    key[obj.level] = obj.key

                    iv[obj.level] = obj.iv

                    localStorage.setItem('key', JSON.stringify(key))
                    
                    localStorage.setItem('iv', JSON.stringify(iv))

                    alert('导入成功！')
                }

                else
                    alert('导入失败！')
            }
        })()">导入通行等级</button>
        <input class="output" readonly="true" placeholder="加密结果"></input>
    </div>
</body>
<script src="./index.js"></script>
<script src="./base64.js"></script>
<script src="./mtml.js"></script>
<script type="module">
    import { nanoid } from './nanoid.js'

    document.querySelector('#newKey').onclick = () => document.querySelector('#key').value = nanoid(32)

    document.querySelector('#newIv').onclick = () => document.querySelector('#iv').value = nanoid(16)
</script>
<script>
    try {
        const key = JSON.parse(localStorage.getItem('key')).default
        
        if (typeof key !== 'undefined')
            document.querySelector('#key').value = key
    }
    catch {
        if (typeof localStorage.getItem('key') === 'string') {
            document.querySelector('#key').value = localStorage.getItem('key')

            localStorage.setItem('key', JSON.stringify({ default: localStorage.getItem('key') }))
        }
        // 当为null时类型为object 算作没有保存过默认值
        else {
            localStorage.setItem('key', '{}')
        }
    }

    try {
        const iv = JSON.parse(localStorage.getItem('iv')).default
        
        if (typeof iv !== 'undefined')
            document.querySelector('#iv').value = iv
    }
    catch {
        if (typeof localStorage.getItem('iv') === 'string') {
            document.querySelector('#iv').value = localStorage.getItem('iv')

            localStorage.setItem('iv', JSON.stringify({ default: localStorage.getItem('iv') }))
        }
        // 当为null时类型为object 算作没有保存过默认值
        else {
            localStorage.setItem('iv', '{}')
        }
    }

    const params = window.location.search.substr(1)

    if (params.length === 0) {
        document.title = 'mtml测试'

        document.querySelector('#percent').remove()

        document.querySelector('.lds-ellipsis').remove()

        document.querySelector('#none').id = 'general'
    }

    else {
        var operate

        var default_ = true

        var modes = {}

        const array = params.split('&')

        for (let i = 0, len = array.length; i < len; i++) {
            const dic = array[i].split('=')

            switch (dic[0]) {
                case 'url':
                    operate = (isDownload, key = document.querySelector('#key').value, iv = document.querySelector('#iv').value, clean) => {
                        if (dic[1].includes('http://') || dic[1].includes('https://'))
                            document.querySelector('#input').value = dic[1]

                        else
                            if (dic[1][0] === '/')
                                document.querySelector('#input').value = window.location.origin + dic[1]

                            else
                                document.querySelector('#input').value = window.location.origin + '/' + dic[1]

                        // const key = document.querySelector('#key').value

                        // const iv = document.querySelector('#iv').value

                        if (key !== null && iv !== null) {
                            GetMtmlCall(document.querySelector('#input').value, key, iv, res => {
                                if (typeof res === 'string')
                                    if (!res.includes('</html>')) {
                                        alert('自动解析失败！请检查源文件是否为合法的MTML、密钥及向量！')

                                        clean()
                                    }

                                    else if (typeof isDownload !== 'undefined' && isDownload === true) {
                                        const text = new Blob([res], {
                                            type: 'application/force-download;charset=UTF-8'
                                        })

                                        const download = document.createElement('a')
                
                                        const url = window.URL.createObjectURL(text)

                                        download.href = url

                                        download.download = document.querySelector('#input').value
                                            .substr(document.querySelector('#input').value.lastIndexOf('/') + 1)
                                            .replace('.mtml', '.html')

                                        download.click()

                                        window.URL.revokeObjectURL(url)

                                        clean()
                                    }
                                    
                                    else {
                                        document.close()

                                        document.write(res)

                                        document.close()
                                    }

                                else if (typeof res === 'object') {
                                    if (typeof isDownload !== 'undefined' && isDownload === true) {
                                        const text = new Blob([res], {
                                            type: 'application/force-download;charset=UTF-8'
                                        })

                                        const download = document.createElement('a')
                
                                        const url = window.URL.createObjectURL(text)

                                        download.href = url

                                        download.download = document.querySelector('#input').value
                                            .substr(document.querySelector('#input').value.lastIndexOf('/') + 1)
                                            .replace('.mdf', '.pdf')

                                        download.click()

                                        window.URL.revokeObjectURL(url)

                                        clean()
                                    }

                                    else {
                                        const pdf = new Blob([res], {
                                            type: 'application/pdf;charset=UTF-8'
                                        })

                                        const url = window.URL.createObjectURL(pdf)
                                        
                                        window.location = url

                                        window.URL.revokeObjectURL(url)
                                    }
                                }
                                else
                                    clean()
                            }, xhr => {
                                xhr.onprogress = e => {
                                    document.querySelector('#percent').textContent = `${(e.loaded / e.total * 100).toFixed(2)}%`
                                }
                            }, !document.querySelector('#input').value.endsWith('.mdf'), document.querySelector('#input').value.endsWith('.mdf'))
                        }

                        else
                            clean()
                    }

                    break

                case 'download':
                    if (dic[1] === '1')
                        modes.download = true

                    break

                case 'access':
                    switch (dic[1]) {
                        case '1':
                            modes.key = JSON.parse(localStorage.getItem('key')).access1

                            modes.iv = JSON.parse(localStorage.getItem('iv')).access1

                            break

                        case '2':
                            modes.key = JSON.parse(localStorage.getItem('key')).access2

                            modes.iv = JSON.parse(localStorage.getItem('iv')).access2

                            break
                            
                        case '3':
                            modes.key = JSON.parse(localStorage.getItem('key')).access3

                            modes.iv = JSON.parse(localStorage.getItem('iv')).access3

                            break
                            
                        case '4':
                            modes.key = JSON.parse(localStorage.getItem('key')).access4

                            modes.iv = JSON.parse(localStorage.getItem('iv')).access4

                            break

                        default:
                            modes.key = JSON.parse(localStorage.getItem('key'))[dic[1]]

                            modes.iv = JSON.parse(localStorage.getItem('iv'))[dic[1]]

                            break
                    }

                    break
            }
        }

        if (typeof operate !== 'undefined') {
            default_ = false

            operate(modes.download, modes.key, modes.iv, () => {
                document.title = 'mtml测试'

                document.querySelector('#percent').remove()

                document.querySelector('.lds-ellipsis').remove()

                document.querySelector('#none').id = 'general'
            })
        }

        if (default_) {
            document.title = 'mtml测试'

            document.querySelector('#percent').remove()

            document.querySelector('.lds-ellipsis').remove()

            document.querySelector('#none').id = 'general'
        }
    }
</script>
</html>
